/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

/* This file has been modified by Open Source Strategies, Inc. */


import org.ofbiz.base.util.UtilMisc;
import org.ofbiz.entity.util.EntityUtil;

quoteCoefficientsIt = quoteCoefficients.iterator();
costMult = 0.0;
while (quoteCoefficientsIt.hasNext()) {
    quoteCoefficient = quoteCoefficientsIt.next();
    value = quoteCoefficient.getDouble("coeffValue");
    if (value != null) {
        costMult += value;
    }
}
double costToPriceMult = 1.0;
if (costMult != 100) {
    costToPriceMult = 100 / (100 - costMult);
}

double totalCost = 0.0;
double totalPrice = 0.0;
double totalCostMult = 0.0;
currency = quote.getString("currencyUomId");
quoteItemAndCostInfos = new java.util.ArrayList();
quoteItemsIt = quoteItems.iterator();
while (quoteItemsIt.hasNext()) {
    quoteItem = quoteItemsIt.next();
    double defaultQuoteUnitPrice = 0.0;
    double averageCost = 0.0;
    double unitPrice = 0.0;
    double quantity = 1.0;
    double selectedAmount = 1.0;
    if (quoteItem.get("quantity") != null) {
        quantity = (quoteItem.getDouble("quantity")).doubleValue();
    }
    if (quoteItem.get("selectedAmount") != null) {
        selectedAmount = (quoteItem.getDouble("selectedAmount")).doubleValue();
    }
    if (selectedAmount == 0.0) {
        selectedAmount = 1.0;
    }
    if (quoteItem.get("quoteUnitPrice") != null) {
        unitPrice = (quoteItem.getDouble("quoteUnitPrice")).doubleValue();
    }

    try {
        if (currency != null && quoteItem.get("productId") != null) {
            productPrices = delegator.findByAnd("ProductPrice", UtilMisc.toMap("productId", quoteItem.getString("productId"),
                                                                              "currencyUomId", currency,
                                                                              "productPriceTypeId", "AVERAGE_COST"));
            productPrices = EntityUtil.filterByDate(productPrices);
            productPrice = EntityUtil.getFirst(productPrices);
            if (productPrice != null && productPrice.get("price") != null) {
                averageCost = (productPrice.getDouble("price")).doubleValue();
            }
        }
        defaultQuoteUnitPrice = averageCost * costToPriceMult * selectedAmount;
        totalCost += (averageCost * quantity);
        totalPrice += (unitPrice * quantity);
    } catch(Exception exc) {
        Debug.logError("Problems getting the averageCost for quoteItem: " + quoteItem);
    }

    quoteItemAndCostInfo = new java.util.HashMap(quoteItem);
    quoteItemAndCostInfo.put("averageCost", averageCost);
    quoteItemAndCostInfo.put("costToPriceMult", costToPriceMult);
    quoteItemAndCostInfo.put("defaultQuoteUnitPrice", defaultQuoteUnitPrice);
    quoteItemAndCostInfos.add(quoteItemAndCostInfo);
}

context.put("costMult", costMult);
context.put("costToPriceMult", costToPriceMult);
context.put("quoteItemAndCostInfos", quoteItemAndCostInfos);

context.put("totalCost", totalCost);
context.put("totalPrice", totalPrice);
context.put("totalCostMult", (totalCost != 0? totalPrice / totalCost: 0));

